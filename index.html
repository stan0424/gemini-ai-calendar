<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gemini AI Calendar（Feed 版）</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--ink:#e6edf3;--ink-dim:#9fb0c0;--line:#243045;--accent:#3b82f6;--chip:#1e293b}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial}
    a{color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 80px 16px}
    .h1{font-size:22px;font-weight:800;letter-spacing:.02em}
    .row{display:flex;gap:20px;align-items:flex-start}
    .info{flex:1 1 auto;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;min-height:88px}
    .kv{display:grid;grid-template-columns:80px 1fr;gap:6px 12px}
    .kv b{color:var(--ink-dim);font-weight:600}
    .btns{display:flex;gap:10px;margin-top:12px}
    .btn{background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#3e4b66}
    /* Sidebar list */
    .side{position:sticky;top:16px;width:360px;max-height:calc(100vh - 32px);overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:14px}
    .side .hd{position:sticky;top:0;background:var(--card);padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .side .hd .cnt{color:var(--ink-dim)}
    .list{padding:8px}
    .li{display:grid;grid-template-columns:1fr 74px;gap:4px 12px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.02))}
    .tt{font-weight:700}
    .meta{font-size:12px;color:var(--ink-dim)}
    .chip{font-size:12px;padding:2px 8px;border-radius:9999px;background:#0f1a2e;border:1px solid var(--line);text-align:center;color:#9ec3ff}
    .muted{color:var(--ink-dim)}
    /* debug small toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#0f172a;border:1px solid var(--line);border-radius:10px;padding:8px 10px;color:#a6e3a1}
    @media (max-width:1000px){ .row{flex-direction:column} .side{position:relative;width:auto;max-height:none} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">Gemini AI Calendar（Feed 版）</div>

    <div class="row" style="margin-top:14px">
      <div class="info">
        <div class="kv">
          <b>API：</b><div id="kv-api" class="muted">—</div>
          <b>Owner：</b><div id="kv-owner" class="muted">—</div>
          <b>可用 URL：</b><div id="kv-url" class="muted">—</div>
        </div>
        <div class="btns">
          <button id="btn-reload" class="btn">重新載入</button>
          <button id="btn-reset" class="btn" title="清掉 localStorage 重新指定 owner/api">重設 API/Owner</button>
        </div>
      </div>

      <aside class="side" aria-label="提醒清單">
        <div class="hd">
          <div>提醒列表</div>
          <div class="cnt" id="cnt">0 筆</div>
        </div>
        <div id="list" class="list"></div>
      </aside>
    </div>
  </div>

  <script>
    // ====== 參數 / 永久儲存 ======
    const url = new URL(location.href);
    const qOwner = url.searchParams.get('owner') || '';
    const qApi   = url.searchParams.get('api')   || '';

    if (qOwner) localStorage.setItem('feed_owner_id', qOwner);
    if (qApi)   localStorage.setItem('feed_api_base', qApi);

    const owner = (qOwner || localStorage.getItem('feed_owner_id') || '').trim();
    let   api   = (qApi   || localStorage.getItem('feed_api_base') || 'https://line-webhook.lienyusen.workers.dev').trim();
    api = api.replace(/\/+$/,''); // 移除多餘結尾斜線
    const feedBase = api.endsWith('/feed') ? api : (api + '/feed');

    // ====== UI：顯示 API / OWNER / 可分享 URL ======
    const KV_API   = document.getElementById('kv-api');
    const KV_OWNER = document.getElementById('kv-owner');
    const KV_URL   = document.getElementById('kv-url');
    KV_API.textContent   = feedBase;
    KV_OWNER.textContent = owner || '（尚未設定）';
    KV_URL.textContent   = owner ? (location.origin + location.pathname + '?owner=' + encodeURIComponent(owner) + '&api=' + encodeURIComponent(api)) : '（請先設定 owner/api）';

    // ====== 小工具 ======
    const toLocal = (s) => {
      if (!s) return '';
      // 兼容 "2025-11-06 19:40:31" 與 "2025-11-06T19:40:31Z"
      const t = s.includes(' ') ? s.replace(' ', 'T') : s;
      const d = new Date(t);
      if (isNaN(d)) return s;
      return d.toLocaleString('zh-TW', { hour12:false });
    };
    const bestTime = (it) => it.due_at || it.created_at || '';

    // ====== 讀取 + 繪製 ======
    async function loadFeed() {
      const listEl = document.getElementById('list');
      const cntEl  = document.getElementById('cnt');

      listEl.innerHTML = '<div class="muted" style="padding:10px">載入中…</div>';

      if (!owner || !feedBase) {
        listEl.innerHTML = '<div class="muted" style="padding:10px">請以 <b>?owner=...&api=...</b> 指定，或按「重設 API/Owner」。</div>';
        cntEl.textContent = '0 筆';
        return;
      }
      // 寫回 localStorage（確保後續刷新仍使用現在的設定）
      localStorage.setItem('feed_owner_id', owner);
      localStorage.setItem('feed_api_base', api);

      const feedUrl = `${feedBase}?owner=${encodeURIComponent(owner)}&limit=200`;
      let ok=false, items=[], error='';

      try {
        const res  = await fetch(feedUrl, { credentials:'include' });
        const data = await res.json();
        ok    = !!data.ok;
        items = Array.isArray(data.items) ? data.items : [];
      } catch(e) {
        ok=false; error = e.message || 'fetch error';
      }

      if (!ok) {
        listEl.innerHTML = `<div class="muted" style="padding:10px;color:#fca5a5">讀取失敗：${error||'unknown'}</div>`;
        cntEl.textContent = '0 筆';
        return;
      }

      // 不再 slice(16)，並且不再限制 id 必須以 rem- 開頭；任何有 id 的都顯示
      const normalized = items
        .filter(it => it && it.id) // 包含 rem- 與 ui- 等
        .map(it => ({ ...it, _ts: new Date(bestTime(it)?.replace(' ','T')).getTime() || 0 }))
        .sort((a,b) => b._ts - a._ts); // 新 → 舊

      cntEl.textContent = `${normalized.length} 筆`;

      if (!normalized.length) {
        listEl.innerHTML = '<div class="muted" style="padding:10px">目前沒有資料。</div>';
        return;
      }

      const html = normalized.map(it => {
        const when = bestTime(it);
        return `
          <div class="li">
            <div>
              <div class="tt">${escapeHtml(it.title || '(未命名)')}</div>
              <div class="meta">${toLocal(when)}${it.location ? '・' + escapeHtml(it.location) : ''}</div>
            </div>
            <div class="chip">${escapeHtml(it.type || 'reminder')}</div>
          </div>`;
      }).join('');

      listEl.innerHTML = html;
    }

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // ====== 控制鈕 ======
    document.getElementById('btn-reload').addEventListener('click', loadFeed);
    document.getElementById('btn-reset').addEventListener('click', () => {
      localStorage.removeItem('feed_api_base');
      localStorage.removeItem('feed_owner_id');
      location.href = location.pathname; // 乾淨頁重新進入
    });

    // ====== 首次載入 ======
    loadFeed().then(() => {
      // 可選：畫面右下角吐司（只在有 owner 時顯示一次）
      if (owner) {
        const t=document.createElement('div');
        t.className='toast';
        t.textContent='已載入 ' + owner + ' 的 Feed（上方按鈕可重整/重設）。';
        document.body.appendChild(t);
        setTimeout(()=>t.remove(),2800);
      }
    });
  </script>
</body>
</html>
